<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">

        <link rel="shortcut icon" href="/favicon.gif">
        
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">

        <link href="https://fonts.googleapis.com/css?family=Ubuntu|Ubuntu+Mono" rel="stylesheet"> 

        <title>Captcha Service With Python and Redis</title>

        <link rel="stylesheet" href="/css/stylesheet.css">
    </head>
    <body>
      <div class="container-fluid">
        <nav class="navbar navbar-expand-md navbar-light">

          
          <span class="navbar-brand mb-0 h1"></span>

          <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle Navigation" name="button">
            <span class="navbar-toggler-icon"></span>
          </button>

          <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
            <div class="navbar-nav">
              <a class="nav-item nav-link " href="/">Home</a>
              <a class="nav-item nav-link" href="https://github.com/yjlo123" target="_blank">GitHub</a>
              
              <a class="nav-item nav-link " href="/about/">About</a>
            </div>
          </div>
        </nav>

        <section id="page-title">
          
        </section>


<div class="blog-post">
  <h1>Captcha Service With Python and Redis</h1>
  <div class="blog-post-subheader">
    <time>17 Feb 2019</time>
  </div><ul class="tags">
  
   <li>
     <a href="/tags/captcha">captcha</a>
   </li>
  
   <li>
     <a href="/tags/python">python</a>
   </li>
  
   <li>
     <a href="/tags/redis">redis</a>
   </li>
  
   <li>
     <a href="/tags/web">web</a>
   </li>
  
</ul>
<div class="blog-post-content">
    

<h2 id="intro">Intro</h2>

<p>While implementing my new personal website, I added a <code>Contact</code> page, on which people can send messages to me by filling a form.</p>

<p>This is a low-cost way to say something to the owner of the website. It can be anonymous, for instance, you can just type <code>yo</code> in the message box and click <code>Send</code>, then seconds later, I receive an email showing the message, and I have no idea who you are.</p>

<p>This feature looks convenient but also opens a window to everyone who wants to spam me. Someone may even willing to spend time writing a load-testing script for me (sending hundreds of thousands of messages to me within seconds to see if the website can handle it).</p>

<p>To prevent such case happens, I have to add a <code>CAPTCHA</code> (<code>c</code>ompletely <code>a</code>utomated <code>p</code>ublic <code>T</code>uring test to tell <code>c</code>omputers and <code>h</code>umans <code>a</code>part) field. As a result, it became hard for people to write a program to flood my inbox.</p>

<p>My homepage is a static page generated by <code>Vue</code>, it requests external APIs through Javascript. Thus, the sending email service, or with the captcha service, is a standalone service running on my server.</p>

<h2 id="design">Design</h2>

<pre><code>   User           Web Page               Server            Redis
    |                |                      |                |
    |                |-----request key-----&gt;|                |
    |                |                 generate key          |    (1)
    |                |                      |---save key----&gt;|
    |                |&lt;-----return key------|                |
    |                |--request img by key-&gt;|                |
    |                |              generate code &amp; img      |    (2)
    |                |                      |---save code---&gt;|
    |                |&lt;-----return img------|                |
    |---input code--&gt;|                      |                |
    |                |----send code &amp; key--&gt;|                |    (3)
    |                |                      |------key------&gt;|
    |                |                      |&lt;-----code------|
    |                |                compare codes          |
    |                |             op(e.g. send email)       |
    |                |&lt;----return result----|                |
</code></pre>

<h4 id="1-cache-key">(1) Cache Key</h4>

<p>The first request initialized by the client is asking for a <code>key</code>, which is used as the key in Redis as well as the argument used for asking for Captcha image in the following request.</p>

<p>The reason why the client has to send two separate requests to get the Captcha image is that the server is not able to return the key and the image data at the same time. This API is designed to be stateless, otherwise, you can manage a session instead of keeping an identifier like the <code>key</code> value in this example.</p>

<p>In the following code snippet, we also remove the Captcha data from Redis by the key given in the request. This allows the user to refresh the captcha image and the server clears the previous captcha. Besides, each key will expires automatically (deleted from Redis) if it is not cleared by any request.</p>

<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#888">@app.route</span>(BASE_URL + <span style="color:#a50">&#34;/captcha_pre&#34;</span>)
<span style="color:#00a">def</span> <span style="color:#0a0">captcha_pre</span>():
	<span style="color:#aaa;font-style:italic"># ckey refresh, remove the previous one</span>
	ckey = request.args.get(<span style="color:#a50">&#39;ckey&#39;</span>)
	<span style="color:#00a">if</span> ckey:
		r.delete(ckey)

	key = <span style="color:#0aa">str</span>(uuid.uuid4())
	r.<span style="color:#0aa">set</span>(key, CAPTCHA_INIT_VALUE, ex=CAPTCHA_INIT_EXPIRE)
	<span style="color:#00a">return</span> json.dumps({<span style="color:#a50">&#39;ckey&#39;</span>: key})</code></pre></td></tr></table>
</div>
</div>

<h4 id="2-captcha-key-image-pair">(2) Captcha Key-Image Pair</h4>

<p>The <a href="https://pypi.org/project/captcha/">captcha</a> module is used here to generate the Captcha image.
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00a">from</span> <span style="color:#0aa;text-decoration:underline">captcha.image</span> <span style="color:#00a">import</span> ImageCaptcha

image_captcha = ImageCaptcha()

<span style="color:#888">@app.route</span>(BASE_URL + <span style="color:#a50">&#34;/captcha&#34;</span>)
<span style="color:#00a">def</span> <span style="color:#0a0">captcha_image</span>():
	ckey = request.args.get(<span style="color:#a50">&#39;ckey&#39;</span>)

	<span style="color:#aaa;font-style:italic"># verify captcha key</span>
	<span style="color:#00a">try</span>:
		uuid_obj = uuid.UUID(ckey, version=<span style="color:#099">4</span>)
	<span style="color:#00a">except</span>:
		<span style="color:#00a">return</span> json.dumps({<span style="color:#a50">&#39;result&#39;</span>: <span style="color:#099">1</span>, <span style="color:#a50">&#39;message&#39;</span>: <span style="color:#a50">&#39;Invalid key&#39;</span>})

	<span style="color:#aaa;font-style:italic"># verify init</span>
	captcha_cache = r.get(ckey)
	<span style="color:#00a">if</span> <span style="color:#00a">not</span> (captcha_cache <span style="color:#00a">and</span> captcha_cache.decode(<span style="color:#a50">&#34;utf-8&#34;</span>) == CAPTCHA_INIT_VALUE):
		<span style="color:#00a">return</span> json.dumps({<span style="color:#a50">&#39;result&#39;</span>: <span style="color:#099">1</span>, <span style="color:#a50">&#39;message&#39;</span>: <span style="color:#a50">&#39;Invalid key&#39;</span>})
	
	<span style="color:#aaa;font-style:italic"># generate captcha</span>
	value = <span style="color:#a50">&#39;&#39;</span>.join(random.choices(CAPTCHA_CHARSET, k=CAPTCHA_LENGTH))
	data = image_captcha.generate(value)

	<span style="color:#aaa;font-style:italic"># cache captcha</span>
	r.<span style="color:#0aa">set</span>(ckey, value, ex=CAPTCHA_EXPIRE)
	<span style="color:#00a">return</span> send_file(data, attachment_filename=<span style="color:#a50">&#34;captcha.jpg&#34;</span>, as_attachment=False)</code></pre></td></tr></table>
</div>
</div></p>

<h4 id="3-verification">(3) Verification</h4>

<p>Nothing magical here, just compare the cached code with the user input. Take note that each captcha is one-time use only, it will be deleted no matter the user input is correct or not.
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00a">def</span> <span style="color:#0a0">verify_captcha</span>(captcha_key, captcha_input):
	captcha_cache = r.get(captcha_key)
	result = False
	<span style="color:#00a">if</span> captcha_cache:
		captcha_cache_str = captcha_cache.decode(<span style="color:#a50">&#34;utf-8&#34;</span>)
		<span style="color:#00a">if</span> (captcha_cache_str.lower() == captcha_input.lower()
			<span style="color:#00a">and</span> <span style="color:#00a">not</span> captcha_cache_str == CAPTCHA_INIT_VALUE):
			result = True
		<span style="color:#aaa;font-style:italic"># clean captcha cache regardless of the result</span>
		r.delete(captcha_key)
	<span style="color:#00a">return</span> result</code></pre></td></tr></table>
</div>
</div></p>

<h2 id="conclusion">Conclusion</h2>

<p>This is one possible way to implement a Captcha service, at least it can protect my mail inbox to a certain extent. In addition, there can be some improvements on it, for example, adding IP limitations, so that users wonâ€™t be able to initialize a huge amount of Captcha data in your Redis cache.</p>

<p>The full code example will be available at my GitHub soon.</p>

  </div>
</div>

      <footer>
        <hr>
        <small>
          &copy; 2019
          <a href="https://siwei.dev/" target="_blank">siwei.dev</a>
        </small>
      </footer>
    </div> 

    
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js" integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T" crossorigin="anonymous"></script>
  </body>
</html>

